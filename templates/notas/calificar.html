<!-- templates/notas/calificar.html -->
{% extends 'layout.html' %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/calificar.css') }}">
{% endblock extra_css %}

{% block content %}
<div class="container mt-4">
  <div class="row justify-content-center">
    <div class="col-md-10">
      <div class="form-wrapper">
        <h2 class="card-title">üìù Calificar Estudiantes por Curso</h2>
        
        <!-- Mensajes -->
        {% if mensaje %}
          <div class="alert alert-{{ tipo_mensaje }} alert-dismissible fade show" role="alert">
            {% if tipo_mensaje == 'warning' %}‚ö†Ô∏è{% elif tipo_mensaje == 'danger' %}‚ùå{% else %}‚ÑπÔ∏è{% endif %}
            {{ mensaje }}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
          </div>
        {% endif %}
        
        <!-- Formulario principal -->
        {% if courses %}
          <div id="message-container"></div>
          
          <!-- Paso 1: Seleccionar curso -->
          <div class="mb-4">
            <label for="course_select" class="form-label fw-bold">Selecciona el curso</label>
            <select id="course_select" class="form-select" required>
              <option value="">Seleccionar curso...</option>
              {% for course in courses %}
                <option value="{{ course.id }}">{{ course.name }}</option>
              {% endfor %}
            </select>
          </div>

          <!-- Spinner de carga -->
          <div id="loading-spinner" class="loading-spinner">
            <div class="spinner-border text-primary">
              <output class="visually-hidden">Cargando estudiantes...</output>
            </div>
            <p class="mt-2 text-muted">Cargando estudiantes del curso...</p>
          </div>

          <!-- Informaci√≥n del curso seleccionado -->
          <div id="course-info" class="student-info" style="display: none;">
            <h5><i class="fas fa-info-circle"></i> Informaci√≥n del curso</h5>
            <p id="course-details" class="mb-0"></p>
          </div>

          <!-- Paso 2: Formulario de calificaci√≥n -->
          <div id="qualification-section" style="display: none;">
            <form id="qualification-form" method="POST" action="{{ url_for('calificaciones.submit_qualification') }}">
              <input type="hidden" id="selected_course_id" name="course_id" value="">
              
              <!-- Lista de estudiantes -->
              <div class="mb-3">
                <label for="student_id" class="form-label fw-bold">Selecciona el estudiante</label>
                <select name="student_id" id="student_id" class="form-select" required>
                  <option value="">Primero selecciona un curso...</option>
                </select>
                <div class="form-text">
                  <i class="fas fa-users"></i> 
                  <span id="student-count">0</span> estudiantes matriculados
                </div>
              </div>

              <!-- Calificaci√≥n -->
              <div class="mb-3">
                <label for="score" class="form-label fw-bold">Ingresa la calificaci√≥n</label>
                <div class="input-group">
                  <input 
                    type="number" 
                    name="score" 
                    id="score" 
                    class="form-control" 
                    min="0" 
                    max="20" 
                    step="0.5" 
                    placeholder="0.0"
                    required>
                  <span class="input-group-text">/20</span>
                </div>
                <div class="form-text">
                  <i class="fas fa-info-circle"></i> 
                  Calificaci√≥n del 0 al 20 (puedes usar decimales como 15.5)
                </div>
              </div>

              <!-- Botones -->
              <div class="d-grid gap-2 d-md-flex justify-content-md-center">
                <button type="submit" class="btn btn-success me-md-2" id="submit-btn" disabled>
                  <i class="fas fa-save"></i> Guardar Calificaci√≥n
                </button>
                <button type="button" class="btn btn-outline-secondary" onclick="resetForm()">
                  <i class="fas fa-redo"></i> Reiniciar
                </button>
                <a href="{{ url_for('dashboard.main') }}" class="btn btn-primary">
                  <i class="fas fa-arrow-left"></i> Volver al Dashboard
                </a>
              </div>
            </form>
          </div>

        {% else %}
          <!-- Sin cursos asignados -->
          <div class="no-data-message">
            <div class="mb-3">
              <i class="fas fa-chalkboard fa-3x text-muted"></i>
            </div>
            <h5 class="text-muted">No tienes cursos asignados</h5>
            <p class="text-muted mb-3">
              No se encontraron cursos asignados a tu cuenta de profesor.
              Contacta al administrador para que te asigne cursos.
            </p>
            <a href="{{ url_for('dashboard.main') }}" class="btn btn-primary">
              <i class="fas fa-arrow-left"></i> Volver al Dashboard
            </a>
          </div>
        {% endif %}
      </div>
    </div>
  </div>
</div>

{% if courses %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const courseSelect = document.getElementById('course_select');
    const studentSelect = document.getElementById('student_id');
    const qualificationSection = document.getElementById('qualification-section');
    const courseInfo = document.getElementById('course-info');
    const courseDetails = document.getElementById('course-details');
    const loadingSpinner = document.getElementById('loading-spinner');
    const studentCount = document.getElementById('student-count');
    const submitBtn = document.getElementById('submit-btn');
    const selectedCourseInput = document.getElementById('selected_course_id');
    const form = document.getElementById('qualification-form');

    // Evento: cambio de curso
    courseSelect.addEventListener('change', function() {
        const courseId = this.value;
        
        if (!courseId) {
            hideQualificationSection();
            return;
        }

        loadStudentsByCourse(courseId);
    });

    // Evento: env√≠o del formulario
    form.addEventListener('submit', function(e) {
        e.preventDefault();
        submitQualification();
    });

    // Evento: validaci√≥n en tiempo real
    document.getElementById('score').addEventListener('input', validateForm);
    studentSelect.addEventListener('change', validateForm);

    function loadStudentsByCourse(courseId) {
        showLoading();
        hideQualificationSection();

        fetch(`{{ url_for('calificaciones.get_students_by_course') }}?course_id=${courseId}`)
            .then(response => response.json())
            .then(data => {
                hideLoading();
                
                if (data.error) {
                    showMessage('‚ùå Error: ' + data.error, 'danger');
                    return;
                }

                if (data.message) {
                    showMessage('‚ÑπÔ∏è ' + data.message, 'info');
                    populateStudents([]);
                    return;
                }

                populateStudents(data.students || []);
                showCourseInfo(courseId);
                showQualificationSection();
            })
            .catch(error => {
                hideLoading();
                showMessage('‚ùå Error de conexi√≥n: ' + error.message, 'danger');
            });
    }

    function populateStudents(students) {
        studentSelect.innerHTML = '<option value="">Seleccionar estudiante...</option>';
        
        students.forEach(student => {
            const option = document.createElement('option');
            option.value = student.id;
            option.textContent = student.name;
            studentSelect.appendChild(option);
        });

        studentCount.textContent = students.length;
        selectedCourseInput.value = courseSelect.value;
        validateForm();
    }

    function showCourseInfo(courseId) {
        const courseName = courseSelect.options[courseSelect.selectedIndex].text;
        courseDetails.innerHTML = `
            <strong>Curso:</strong> ${courseName}<br>
            <strong>ID:</strong> ${courseId}
        `;
        courseInfo.style.display = 'block';
    }

    function showQualificationSection() {
        qualificationSection.style.display = 'block';
    }

    function hideQualificationSection() {
        qualificationSection.style.display = 'none';
        courseInfo.style.display = 'none';
    }

    function showLoading() {
        loadingSpinner.style.display = 'block';
    }

    function hideLoading() {
        loadingSpinner.style.display = 'none';
    }

    function validateForm() {
        const hasStudent = studentSelect.value !== '';
        const hasScore = document.getElementById('score').value !== '';
        const hasCourse = courseSelect.value !== '';
        
        submitBtn.disabled = !(hasStudent && hasScore && hasCourse);
    }

    function submitQualification() {
        showMessage('‚è≥ Guardando calificaci√≥n...', 'info');
        submitBtn.disabled = true;

        const formData = new FormData(form);

        fetch(form.action, {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if (data.mensaje) {
                showMessage('‚úÖ ' + data.mensaje, 'success');
                document.getElementById('score').value = '';
                studentSelect.value = '';
            } else if (data.error) {
                showMessage('‚ùå Error: ' + data.error, 'danger');
            }
        })
        .catch(error => {
            showMessage('‚ùå Error de conexi√≥n: ' + error.message, 'danger');
        })
        .finally(() => {
            validateForm();
        });
    }

    function showMessage(message, type) {
        const messageContainer = document.getElementById('message-container');
        messageContainer.innerHTML = `
            <div class="alert alert-${type} alert-dismissible fade show" role="alert">
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>
        `;
    }

    window.resetForm = function() {
        form.reset();
        courseSelect.value = '';
        hideQualificationSection();
        document.getElementById('message-container').innerHTML = '';
    };
});
</script>
{% endif %}
{% endblock %}